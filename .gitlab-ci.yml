image: registry.gitlab.com/jorgehoyos/certifications:latest

stages:
  - build-image
  - deploy-sam
  - call-api

variables:
  DOCKERFILES_DIR: docker
  DEPLOY_PATH: deploy
  STACK_NAME: certifications-audios

.docker:
  build-and-push:
    - echo -e "\e[0Ksection_start:`date +%s`:docker[collapsed=true]\r\e[0K${TXT_CYAN_BOLD}Tag and push image"
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $IMAGE_TAG $DOCKERFILES_DIR/
    - docker push $IMAGE_TAG
    - echo -e "\e[0Ksection_end:`date +%s`:docker\r\e[0K"

.sam:
  build:
    - echo -e "\e[0Ksection_start:`date +%s`:sam-build[collapsed=true]\r\e[0K${TXT_CYAN_BOLD}Sam Build"
    - sam build
    - echo -e "\e[0Ksection_end:`date +%s`:sam-build\r\e[0K"
  deploy:
    - echo -e "\e[0Ksection_start:`date +%s`:sam-deploy[collapsed=true]\r\e[0K${TXT_CYAN_BOLD}Sam deploy"
    - sam deploy
    - echo -e "\e[0Ksection_end:`date +%s`:sam-deploy\r\e[0K"

build:
  image: docker:19.03.12
  stage: build-image
  rules:
    - changes:
        - $DOCKERFILES_DIR/*
  services:
    - docker:19.03.12-dind
  script:
    - !reference [.docker, build-and-push]
  variables:
    IMAGE_TAG: $CI_REGISTRY_IMAGE:latest

deploy:
  stage: deploy-sam
  rules:
    - changes:
        - $DEPLOY_PATH/**/*
        - $DEPLOY_PATH/*
  script:
    - cd $SAM_PATH
    - !reference [.sam, build]
    - !reference [.sam, deploy]
  variables:
    SAM_PATH: $DEPLOY_PATH/certifications-audios

call-api:
  stage: call-api
  script:
    - echo -e "\e[0Ksection_start:`date +%s`:callapi[collapsed=true]\r\e[0K${TXT_CYAN_BOLD}Call Audio API"
    - AUDIO_API=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query "Stacks[0].Outputs[?OutputKey=='HelloWorldApi'].OutputValue" --output text)
    - curl --data "$CI_COMMIT_SHA" $AUDIO_API
    - echo -e "\e[0Ksection_end:`date +%s`:callapi\r\e[0K"

.transform-file:
  stage: transform-file
  script:
    - aws polly start-speech-synthesis-task --output-format mp3 --output-s3-bucket-name jorgehoyos --text file://ec2-fundamentals.md --voice-id Joanna
